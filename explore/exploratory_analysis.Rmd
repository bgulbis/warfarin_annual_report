---
title: "Warfarin Dosing Service"
subtitle: "Exploratory Data Analysis"
author: "Brian Gulbis"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
    code_folding: hide
    fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r data, message=FALSE}
library(tidyverse)
library(purrrlyr)
library(plotly)
library(themebg)

# prevent peer checking due to MH firewall
if (.Platform$OS.type == "windows") {
    httr::set_config(httr::config(ssl_verifypeer = 0L))
}

x <- dirr::get_rds_s3("warfarin-annual-report", "data/tidy/")
```

```{r, fig.cap="Distribution of warfarin dose by day of therapy"}
p <- data_daily %>%
    filter(warfarin_day <= 10) %>%
    dmap_at("warfarin_day", as.integer) %>%
    left_join(data_warfarin[c("millennium.id", "group", "initiation", "indication_group")], by = "millennium.id") %>%
    ggplot(aes(x = factor(warfarin_day), y = med.dose, color = group)) +
    geom_boxplot() +
    xlab("Day of therapy") +
    ylab("Warfarin dose (mg)") +
    scale_color_brewer("Group", palette = "Set1", labels = c("Pharmacy", "Traditional")) +
    theme_bg()

ggplotly(p, dynamicTicks = TRUE)
```

```{r, fig.cap="Relationship between warfarin dose and INR"}
p <- data_daily %>%
    filter(warfarin_day <= 10,
           med.dose > 0,
           med.dose <= 15,
           !is.na(inr)) %>%
    # dmap_at("warfarin_day", as.integer) %>%
    left_join(data_warfarin[c("millennium.id", "group", "initiation", "indication_group")], by = "millennium.id") %>%
    ggplot(aes(x = med.dose, y = inr)) +
    geom_point(aes(color = group), shape = 1) +
    xlab("Warfarin dose (mg)") +
    ylab("INR") +
    scale_color_brewer("Group", palette = "Set1", labels = c("Pharmacy", "Traditional")) +
    theme_bg()

ggplotly(p, dynamicTicks = TRUE)
```
